var DEFAULT_LAT=-27.4698,DEFAULT_LNG=153.0251,DEFAULT_ZOOM=15,LATLNG_DECIMAL_PLACES=5,REFRESH_UPDATE_INTERVAL=1e3,REFRESH_INTERVAL=15e3,LABEL_SHOW_ZOOM_LEVEL=12,$refreshStatus=document.getElementById("refresh"),search=URI().search(!0);function refreshRoutesPanel(){function addRoute(){var url;""!==$inputRoute.value&&(routes.find(function(r){return r===$inputRoute.value})?$inputRoute.value="":(routes.push($inputRoute.value),url=URI().setSearch({routes:routes.join(",")}),window.history.pushState("","",url.toString()),refreshRoutesPanel()))}var search=URI().search(!0),routes=[],$routes=(search.routes&&(routes=search.routes.split(",")).sort(),document.querySelector("#routes")),$inputRoute=($routes.innerHTML="",routes.forEach(function(route){var $route=document.createElement("span");$route.classList.add("route"),$route.innerHTML=route,$route.onclick=function(){var newRoutes=routes.filter(function(r){return route!==r}),newRoutes=URI().setSearch({routes:newRoutes.join(",")});window.history.pushState("","",newRoutes.toString()),refreshRoutesPanel()},$routes.appendChild($route)}),document.createElement("input")),search=($inputRoute.type="text",$inputRoute.placeholder="Add route",$inputRoute.maxLength=4,$inputRoute.onfocus=function(){window.onresize=null},$inputRoute.onblur=function(){window.onresize=refreshRoutesPanel,addRoute()},$inputRoute.onkeyup=function(e){13==e.keyCode&&(window.onresize=refreshRoutesPanel,addRoute())},$routes.appendChild($inputRoute),window.innerWidth),routesWidth=$routes.offsetWidth;$routes.style.left=search/2-routesWidth/2}refreshRoutesPanel(),window.onresize=refreshRoutesPanel;var zoom,map=L.map("map",{attributionControl:!1}),shapeGroup=(search.lat&&search.lng?(zoom=search.z||DEFAULT_ZOOM,map.setView([search.lat,search.lng],zoom)):map.setView([DEFAULT_LAT,DEFAULT_LNG],DEFAULT_ZOOM),!navigator.geolocation||search.lat&&search.lng||navigator.geolocation.getCurrentPosition(function(position){map.setView([position.coords.latitude,position.coords.longitude],DEFAULT_ZOOM)}),map.on("moveend",function(e){var latlng=map.getCenter(),latlng=URI().setSearch({lat:latlng.lat.toFixed(LATLNG_DECIMAL_PLACES),lng:latlng.lng.toFixed(LATLNG_DECIMAL_PLACES),z:map.getZoom()});window.history.pushState("","",latlng.toString()),remaining=0,getFeed()}),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map),L.layerGroup().addTo(map)),layerGroup=L.layerGroup().addTo(map),vehicleLayerLookup={};function toggleLabels(){var id,zoom=map.getZoom();for(id in vehicleLayerLookup){var marker=vehicleLayerLookup[id];marker._icon&&(LABEL_SHOW_ZOOM_LEVEL<=zoom?L.DomUtil.removeClass(marker._icon,"hide-label"):L.DomUtil.addClass(marker._icon,"hide-label"))}}function vehicleLabel(route,direction){var html='<span class="vehicle-label">';return"in"===direction&&(html+="&lt;"),html+=route,"out"===direction&&(html+="&gt;"),html+="</span>"}function delayLabel(delay){var minutes=Math.floor(Math.abs(delay)/60),seconds=Math.abs(delay)-60*minutes,label="";return minutes&&(label+=minutes.toString()+"m"),seconds&&(label+=seconds.toString()+"s"),minutes&&seconds?'<span class="delay-label '+(0<delay?"late":"early")+'">'+label+"</span>":""}function createIcon(routeType,route,direction,delay){route="<div>"+vehicleLabel(route,direction)+"</div>";return delayLabel(delay)&&(route+='<div class="delay-cont">'+delayLabel(delay)+"</div>"),L.divIcon({className:"div-icon "+routeType,html:route})}map.on("zoom",toggleLabels);var isFetching=!1,remaining=0;function getFeed(){if(!isFetching){var feedUrl,bounds;if(!(0<remaining))return isFetching=!0,$refreshStatus.innerHTML="Updating",feedUrl=URI("feed"),bounds=map.getBounds(),feedUrl=(feedUrl=(feedUrl=(feedUrl=feedUrl.addSearch("neLat",bounds.getNorthEast().lat.toFixed(6))).addSearch("neLng",bounds.getNorthEast().lng.toFixed(6))).addSearch("swLat",bounds.getSouthWest().lat.toFixed(6))).addSearch("swLng",bounds.getSouthWest().lng.toFixed(6)),(bounds=URI().search(!0)).routes&&(feedUrl=feedUrl.addSearch("routes",bounds.routes)),fetch(feedUrl.toString()).then(function(response){if(200===response.status)return response.json().then(function(entities){entities.forEach(function(e){var icon,marker=vehicleLayerLookup[e.id];marker?(icon=createIcon(e.routeType,e.route,e.direction,e.delay),marker.setIcon(icon),marker._icon&&(e.longitude&&e.latitude?L.DomUtil.removeClass(marker._icon,"disconnected"):L.DomUtil.addClass(marker._icon,"disconnected")),e.latitude&&e.longitude&&(marker.setLine([[marker.options.lastPosition.latitude,marker.options.lastPosition.longitude],[e.latitude,e.longitude]]),marker.options.lastPosition={latitude:e.latitude,longitude:e.longitude},marker.start())):(icon=createIcon(e.routeType,e.route,e.direction,e.delay),(marker=L.animatedMarker([[e.latitude,e.longitude]],{icon:icon,interval:REFRESH_INTERVAL-1e3,lastPosition:{latitude:e.latitude,longitude:e.longitude}})).addTo(layerGroup),e=(vehicleLayerLookup[e.id]=marker)._icon.firstChild.getBoundingClientRect(),icon.options.iconSize=[e.width,e.height],marker.setIcon(icon))});var entityIds=entities.map(function(e){return e.id});Object.keys(vehicleLayerLookup).filter(function(l){return!entityIds.includes(l)}).forEach(function(l){vehicleLayerLookup[l].remove(),delete vehicleLayerLookup[l]}),toggleLabels(),$refreshStatus.innerHTML="Updated",isFetching=!1,remaining=REFRESH_INTERVAL})}).catch(function(e){for(var id in vehicleLayerLookup){id=vehicleLayerLookup[id];id.stop&&id.stop(),id._icon&&L.DomUtil.addClass(id._icon,"disconnected")}$refreshStatus.innerHTML="Error",isFetching=!1,remaining=REFRESH_INTERVAL,console.error(e)});$refreshStatus.innerHTML="Updating in "+remaining/1e3+" sec",remaining-=REFRESH_UPDATE_INTERVAL}}getFeed(),setInterval(getFeed,REFRESH_UPDATE_INTERVAL);