var DEFAULT_LAT=-27.4698,DEFAULT_LNG=153.0251,DEFAULT_ZOOM=15,LATLNG_DECIMAL_PLACES=5,REFRESH_UPDATE_INTERVAL=1e3,REFRESH_INTERVAL=15e3,LABEL_SHOW_ZOOM_LEVEL=12,$refreshStatus=document.getElementById("refresh"),search=URI().search(!0);function refreshRoutesPanel(){var search=URI().search(!0),routes=[];search.routes&&(routes=search.routes.split(",")).sort();var $routes=document.querySelector("#routes");$routes.innerHTML="",routes.forEach(function(route){var $route=document.createElement("span");$route.classList.add("route"),$route.innerHTML=route,$route.onclick=function(){var newRoutes=routes.filter(function(r){return route!==r}),url=URI().setSearch({routes:newRoutes.join(",")});window.history.pushState("","",url.toString()),refreshRoutesPanel()},$routes.appendChild($route)});var $inputRoute=document.createElement("input");$inputRoute.type="text",$inputRoute.placeholder="Add route",$inputRoute.maxLength=4;var addRoute=function(){if(""!==$inputRoute.value)if(routes.find(function(r){return r===$inputRoute.value}))$inputRoute.value="";else{routes.push($inputRoute.value);var url=URI().setSearch({routes:routes.join(",")});window.history.pushState("","",url.toString()),refreshRoutesPanel()}};$inputRoute.onfocus=function(){window.onresize=null},$inputRoute.onblur=function(){window.onresize=refreshRoutesPanel,addRoute()},$inputRoute.onkeyup=function(e){13==e.keyCode&&(window.onresize=refreshRoutesPanel,addRoute())},$routes.appendChild($inputRoute);var windowWidth=window.innerWidth,routesWidth=$routes.offsetWidth;$routes.style.left=windowWidth/2-routesWidth/2}refreshRoutesPanel(),window.onresize=refreshRoutesPanel;var map=L.map("map",{attributionControl:!1});if(search.lat&&search.lng){var zoom=search.z||DEFAULT_ZOOM;map.setView([search.lat,search.lng],zoom)}else map.setView([DEFAULT_LAT,DEFAULT_LNG],DEFAULT_ZOOM);!navigator.geolocation||search.lat&&search.lng||navigator.geolocation.getCurrentPosition(function(position){map.setView([position.coords.latitude,position.coords.longitude],DEFAULT_ZOOM)}),map.on("moveend",function(e){var latlng=map.getCenter(),url=URI().setSearch({lat:latlng.lat.toFixed(LATLNG_DECIMAL_PLACES),lng:latlng.lng.toFixed(LATLNG_DECIMAL_PLACES),z:map.getZoom()});window.history.pushState("","",url.toString()),remaining=0,getFeed()}),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);var shapeGroup=L.layerGroup().addTo(map),layerGroup=L.layerGroup().addTo(map),vehicleLayerLookup={};function toggleLabels(){var zoom=map.getZoom();for(var id in vehicleLayerLookup){var marker=vehicleLayerLookup[id];marker._icon&&(LABEL_SHOW_ZOOM_LEVEL<=zoom?L.DomUtil.removeClass(marker._icon,"hide-label"):L.DomUtil.addClass(marker._icon,"hide-label"))}}function vehicleLabel(route,direction){var html='<span class="vehicle-label">';return"in"===direction&&(html+="&lt;"),html+=route,"out"===direction&&(html+="&gt;"),html+="</span>"}function delayLabel(delay){var minutes=Math.floor(Math.abs(delay)/60),seconds=Math.abs(delay)-60*minutes,label="";return minutes&&(label+=minutes.toString()+"m"),seconds&&(label+=seconds.toString()+"s"),minutes&&seconds?'<span class="delay-label '+(0<delay?"late":"early")+'">'+label+"</span>":""}function createIcon(routeType,route,direction,delay){var label="<div>"+vehicleLabel(route,direction)+"</div>";return delayLabel(delay)&&(label+='<div class="delay-cont">'+delayLabel(delay)+"</div>"),L.divIcon({className:"div-icon "+routeType,html:label})}map.on("zoom",toggleLabels);var isFetching=!1,remaining=0;function getFeed(){if(!isFetching){if(0<remaining)return $refreshStatus.innerHTML="Updating in "+remaining/1e3+" sec",void(remaining-=REFRESH_UPDATE_INTERVAL);isFetching=!0,$refreshStatus.innerHTML="Updating";var feedUrl=URI("feed"),bounds=map.getBounds();feedUrl=(feedUrl=(feedUrl=(feedUrl=feedUrl.addSearch("neLat",bounds.getNorthEast().lat.toFixed(6))).addSearch("neLng",bounds.getNorthEast().lng.toFixed(6))).addSearch("swLat",bounds.getSouthWest().lat.toFixed(6))).addSearch("swLng",bounds.getSouthWest().lng.toFixed(6));var search=URI().search(!0);return search.routes&&(feedUrl=feedUrl.addSearch("routes",search.routes)),fetch(feedUrl.toString()).then(function(response){if(200===response.status)return response.json().then(function(entities){entities.forEach(function(e){var marker=vehicleLayerLookup[e.id];if(marker){var icon=createIcon(e.routeType,e.route,e.direction,e.delay);marker.setIcon(icon),marker._icon&&(e.longitude&&e.latitude?L.DomUtil.removeClass(marker._icon,"disconnected"):L.DomUtil.addClass(marker._icon,"disconnected")),e.latitude&&e.longitude&&(marker.setLine([[marker.options.lastPosition.latitude,marker.options.lastPosition.longitude],[e.latitude,e.longitude]]),marker.options.lastPosition={latitude:e.latitude,longitude:e.longitude},marker.start())}else{icon=createIcon(e.routeType,e.route,e.direction,e.delay);(marker=L.animatedMarker([[e.latitude,e.longitude]],{icon:icon,interval:REFRESH_INTERVAL-1e3,lastPosition:{latitude:e.latitude,longitude:e.longitude}})).addTo(layerGroup);var bounds=(vehicleLayerLookup[e.id]=marker)._icon.firstChild.getBoundingClientRect();icon.options.iconSize=[bounds.width,bounds.height],marker.setIcon(icon)}});var entityIds=entities.map(function(e){return e.id});Object.keys(vehicleLayerLookup).filter(function(l){return!entityIds.includes(l)}).forEach(function(l){vehicleLayerLookup[l].remove(),delete vehicleLayerLookup[l]}),toggleLabels(),$refreshStatus.innerHTML="Updated",isFetching=!1,remaining=REFRESH_INTERVAL})}).catch(function(e){for(var id in vehicleLayerLookup){var marker=vehicleLayerLookup[id];marker.stop&&marker.stop(),marker._icon&&L.DomUtil.addClass(marker._icon,"disconnected")}$refreshStatus.innerHTML="Error",isFetching=!1,remaining=REFRESH_INTERVAL,console.error(e)})}}getFeed(),setInterval(getFeed,REFRESH_UPDATE_INTERVAL);