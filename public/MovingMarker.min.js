L.interpolatePosition=function(p1,p2,duration,t){var k=t/duration;return k=1<(k=0<k?k:0)?1:k,L.latLng(p1.lat+k*(p2.lat-p1.lat),p1.lng+k*(p2.lng-p1.lng))},L.Marker.MovingMarker=L.Marker.extend({statics:{notStartedState:0,endedState:1,pausedState:2,runState:3},options:{autostart:!1,loop:!1},initialize:function(latlngs,durations,options){L.Marker.prototype.initialize.call(this,latlngs[0],options),this._latlngs=latlngs.map(function(e,index){return L.latLng(e)}),durations instanceof Array?this._durations=durations:this._durations=this._createDurations(this._latlngs,durations),this._currentDuration=0,this._currentIndex=0,this._state=L.Marker.MovingMarker.notStartedState,this._startTime=0,this._startTimeStamp=0,this._pauseStartTime=0,this._animId=0,this._animRequested=!1,this._currentLine=[],this._stations={}},isRunning:function(){return this._state===L.Marker.MovingMarker.runState},isEnded:function(){return this._state===L.Marker.MovingMarker.endedState},isStarted:function(){return this._state!==L.Marker.MovingMarker.notStartedState},isPaused:function(){return this._state===L.Marker.MovingMarker.pausedState},start:function(){this.isRunning()||(this.isPaused()?this.resume():(this._loadLine(0),this._startAnimation(),this.fire("start")))},resume:function(){this.isPaused()&&(this._currentLine[0]=this.getLatLng(),this._currentDuration-=this._pauseStartTime-this._startTime,this._startAnimation())},pause:function(){this.isRunning()&&(this._pauseStartTime=Date.now(),this._state=L.Marker.MovingMarker.pausedState,this._stopAnimation(),this._updatePosition())},stop:function(elapsedTime){this.isEnded()||(this._stopAnimation(),void 0===elapsedTime&&(elapsedTime=0,this._updatePosition()),this._state=L.Marker.MovingMarker.endedState,this.fire("end",{elapsedTime:elapsedTime}))},addLatLng:function(latlng,duration){this._latlngs.push(L.latLng(latlng)),this._durations.push(duration)},moveTo:function(latlng,duration){this._stopAnimation(),this._latlngs=[this.getLatLng(),L.latLng(latlng)],this._durations=[duration],this._state=L.Marker.MovingMarker.notStartedState,this.start(),this.options.loop=!1},addStation:function(pointIndex,duration){pointIndex>this._latlngs.length-2||pointIndex<1||(this._stations[pointIndex]=duration)},onAdd:function(map){L.Marker.prototype.onAdd.call(this,map),!this.options.autostart||this.isStarted()?this.isRunning()&&this._resumeAnimation():this.start()},onRemove:function(map){L.Marker.prototype.onRemove.call(this,map),this._stopAnimation()},_createDurations:function(latlngs,duration){for(var lastIndex=latlngs.length-1,distances=[],totalDistance=0,distance=0,i=0;i<lastIndex;i++)distance=latlngs[i+1].distanceTo(latlngs[i]),distances.push(distance),totalDistance+=distance;var ratioDuration=duration/totalDistance,durations=[];for(i=0;i<distances.length;i++)durations.push(distances[i]*ratioDuration);return durations},_startAnimation:function(){this._state=L.Marker.MovingMarker.runState,this._animId=L.Util.requestAnimFrame(function(timestamp){this._startTime=Date.now(),this._startTimeStamp=timestamp,this._animate(timestamp)},this,!0),this._animRequested=!0},_resumeAnimation:function(){this._animRequested||(this._animRequested=!0,this._animId=L.Util.requestAnimFrame(function(timestamp){this._animate(timestamp)},this,!0))},_stopAnimation:function(){this._animRequested&&(L.Util.cancelAnimFrame(this._animId),this._animRequested=!1)},_updatePosition:function(){var elapsedTime=Date.now()-this._startTime;this._animate(this._startTimeStamp+elapsedTime,!0)},_loadLine:function(index){this._currentIndex=index,this._currentDuration=this._durations[index],this._currentLine=this._latlngs.slice(index,index+2)},_updateLine:function(timestamp){var elapsedTime=timestamp-this._startTimeStamp;if(elapsedTime<=this._currentDuration)return elapsedTime;for(var stationDuration,lineIndex=this._currentIndex,lineDuration=this._currentDuration;lineDuration<elapsedTime;){if(elapsedTime-=lineDuration,void 0!==(stationDuration=this._stations[lineIndex+1])){if(elapsedTime<stationDuration)return this.setLatLng(this._latlngs[lineIndex+1]),null;elapsedTime-=stationDuration}if(++lineIndex>=this._latlngs.length-1){if(!this.options.loop)return this.setLatLng(this._latlngs[this._latlngs.length-1]),this.stop(elapsedTime),null;lineIndex=0,this.fire("loop",{elapsedTime:elapsedTime})}lineDuration=this._durations[lineIndex]}return this._loadLine(lineIndex),this._startTimeStamp=timestamp-elapsedTime,this._startTime=Date.now()-elapsedTime,elapsedTime},_animate:function(timestamp,noRequestAnim){this._animRequested=!1;var elapsedTime=this._updateLine(timestamp);if(!this.isEnded()){if(null!=elapsedTime){var p=L.interpolatePosition(this._currentLine[0],this._currentLine[1],this._currentDuration,elapsedTime);this.setLatLng(p)}noRequestAnim||(this._animId=L.Util.requestAnimFrame(this._animate,this,!1),this._animRequested=!0)}}}),L.Marker.movingMarker=function(latlngs,duration,options){return new L.Marker.MovingMarker(latlngs,duration,options)};